<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Leader Board - Game Arena</title>
    <link rel="stylesheet" href="leaderboard.css" />
</head>
<body>
    <!-- Main Content -->
    <main class="main-content">
        <div class="leaderboard-container">
            <h1>Leader Board</h1>
            <div class="reset-timer">
                <div class="timer-display">
                    <span id="timer-text"> Reset In: 10:00</span>
                </div>
            </div>
            <div class="table-wrapper">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                            <th>Games</th>
                            <th>Played</th>
                            <th>Total Coins</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Leaderboard data will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // API base URL for local testing vs deployment
        const API_BASE = window.location.hostname === '127.0.0.1' ? 'http://127.0.0.1:3000' : '';

        let countdownInterval;
        let timeLeft = 600; // 10 minutes in seconds
        let endTime;

        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_BASE}/api/leaderboard`);
                if (response.ok) {
                    const data = await response.json();
                    const leaderboardBody = document.getElementById('leaderboard-body');
                    leaderboardBody.innerHTML = '';

                    data.leaderboard.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.rank}</td>
                            <td>${user.username}</td>
                            <td>${user.differentGames}</td>
                            <td>${user.gamesPlayed}</td>
                            <td>${user.totalCoins}</td>
                        `;
                        leaderboardBody.appendChild(row);
                    });
                } else {
                    console.error('Failed to load leaderboard');
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        async function resetLeaderboard() {
            try {
                const response = await fetch(`${API_BASE}/api/reset-leaderboard`, {
                    method: 'POST'
                });
                if (response.ok) {
                    loadLeaderboard();
                    resetTimer();
                } else {
                    console.error('Failed to reset leaderboard');
                }
            } catch (error) {
                console.error('Error resetting leaderboard:', error);
            }
        }

        function updateTimer() {
            const now = Date.now();
            timeLeft = Math.max(0, Math.ceil((endTime - now) / 1000));

            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            const timerText = document.getElementById('timer-text');
            if (hours > 0) {
                timerText.textContent = `Reset In: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                timerText.textContent = `Reset In: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            if (timeLeft <= 0) {
                resetLeaderboard();
            }
        }

        function resetTimer() {
            // Instead of creating local timer, fetch the global server timer
            startTimer();
        }

        async function startTimer() {
            try {
                const response = await fetch(`${API_BASE}/api/leaderboard-timer`);
                if (response.ok) {
                    const data = await response.json();
                    endTime = data.endTime;
                    const now = Date.now();
                    if (endTime > now) {
                        timeLeft = Math.ceil((endTime - now) / 1000);
                    } else {
                        // If timer has expired, fetch again to get the updated server time
                        console.log('Timer expired, fetching updated time...');
                        setTimeout(() => startTimer(), 1000); // Wait 1 second and try again
                        return;
                    }
                } else {
                    console.error('Failed to fetch leaderboard timer');
                    // Retry after 2 seconds
                    setTimeout(() => startTimer(), 2000);
                    return;
                }
            } catch (error) {
                console.error('Error fetching leaderboard timer:', error);
                // Retry after 2 seconds
                setTimeout(() => startTimer(), 2000);
                return;
            }
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        function pauseTimer() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function resumeTimer() {
            if (!countdownInterval) {
                countdownInterval = setInterval(updateTimer, 1000);
            }
        }

        // Load leaderboard when page loads
        window.addEventListener('load', () => {
            loadLeaderboard();
            startTimer();
        });

        // Handle tab visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                pauseTimer();
            } else {
                // When tab becomes visible, resume the timer from current time
                if (!countdownInterval && endTime) {
                    resumeTimer();
                } else if (!endTime) {
                    // If no timer exists, start a new one
                    startTimer();
                }
            }
        });

        // Refresh leaderboard every 30 seconds
        setInterval(loadLeaderboard, 30000);
    </script>
</body>
</html>
